name: Feature Branch Owner Notification (Log Only)

on:
  schedule:
    - cron: "0 3 * * 1"   # Weekly (08:30 AM IST)
  workflow_dispatch:

jobs:
  notify-owners:
    name: Scan feature branch owners (not merged to release)
    runs-on: ubuntu-latest

    steps:
      - name: Install required tools
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Scan feature branches (log only)
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          ORG_NAME: TechExplorers2025
          RELEASE_BRANCH: release
        shell: bash
        run: |
          set -euo pipefail

          echo "=============================================="
          echo " GitHub Feature Branch Governance Automation"
          echo " MODE          : LOG ONLY (NO EMAIL)"
          echo " Org           : $ORG_NAME"
          echo " Release Branch: $RELEASE_BRANCH"
          echo " Started at    : $(date)"
          echo "=============================================="

          echo "Fetching repositories from organization..."
          REPOS=$(curl -fsSL -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/orgs/$ORG_NAME/repos?per_page=100" \
            | jq -r '.[].name')

          for repo in $REPOS; do
            echo ""
            echo "------------------------------------------------"
            echo " Repository: $repo"
            echo "------------------------------------------------"

            BRANCHES=$(curl -fsSL -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$ORG_NAME/$repo/branches?per_page=100" \
              | jq -r '.[].name')

            for branch in $BRANCHES; do
              [[ "$branch" != feature/* ]] && continue

              echo ""
              echo "‚û°Ô∏è  Checking feature branch: $branch"

              COMPARE=$(curl -fsSL -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG_NAME/$repo/compare/$RELEASE_BRANCH...$branch")

              STATUS=$(echo "$COMPARE" | jq -r '.status // empty')

              if [[ "$STATUS" == "identical" ]]; then
                echo "   ‚úÖ Already merged to $RELEASE_BRANCH"
                continue
              fi

              echo "   ‚ùå NOT merged to $RELEASE_BRANCH (status: $STATUS)"

              # Get latest commit SHA
              SHA=$(curl -fsSL -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG_NAME/$repo/branches/$branch" \
                | jq -r '.commit.sha')

              # Get commit details
              COMMIT=$(curl -fsSL -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG_NAME/$repo/commits/$SHA")

              OWNER_NAME=$(echo "$COMMIT" | jq -r '.commit.author.name // "Developer"')
              OWNER_EMAIL=$(echo "$COMMIT" | jq -r '.commit.author.email // empty')
              OWNER_LOGIN=$(echo "$COMMIT" | jq -r '.author.login // empty')
              COMMIT_DATE=$(echo "$COMMIT" | jq -r '.commit.author.date // empty')
              COMMIT_MESSAGE=$(echo "$COMMIT" | jq -r '.commit.message | split("\n")[0]')

              echo "   üîé Last Commit Details:"
              echo "      üîë Commit SHA     : $SHA"
              echo "      üóìÔ∏è  Commit Date    : $COMMIT_DATE"
              echo "      üë§ Author Name    : $OWNER_NAME"
              echo "      üìß Author Email   : $OWNER_EMAIL"
              echo "      üßë GitHub Login   : $OWNER_LOGIN"
              echo "      üìù Commit Message : $COMMIT_MESSAGE"

            done
          done

          echo ""
          echo "=============================================="
          echo " Feature Branch Scan Completed (LOG ONLY)"
          echo " Finished at : $(date)"
          echo "=============================================="
