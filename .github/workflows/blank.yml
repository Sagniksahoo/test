name: Feature Branch Scan

on:
  schedule:
    - cron: "0 3 * * 1"   # Weekly
  workflow_dispatch:

jobs:
  scan-feature-branches:
    name: Scan feature branches
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Scan feature branches in all repos
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          ORG_NAME: TechExplorers2025
          RELEASE_BRANCH: release
        shell: bash
        run: |
          set -euo pipefail

          echo "=============================================="
          echo " GitHub Feature Branch Scan"
          echo " Org           : $ORG_NAME"
          echo " Release Branch: $RELEASE_BRANCH"
          echo " Started at    : $(date)"
          echo "=============================================="

          # Fetch repositories
          echo "Fetching repositories from organization..."
          REPOS=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/orgs/$ORG_NAME/repos?per_page=100" \
            | jq -r '.[].name')

          for repo in $REPOS; do
            echo ""
            echo "------------------------------------------------"
            echo " Repository: $repo"
            echo "------------------------------------------------"

            # Check if release branch exists safely (no -f)
            RELEASE_EXISTS=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$ORG_NAME/$repo/branches/$RELEASE_BRANCH")

            if echo "$RELEASE_EXISTS" | jq -e '.name' >/dev/null 2>&1; then
              echo "   ✅ $RELEASE_BRANCH exists in $repo"
            else
              echo "   ⚠️ $RELEASE_BRANCH branch does NOT exist in $repo, skipping comparison"
              continue
            fi

            # Fetch all branches
            BRANCHES=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$ORG_NAME/$repo/branches?per_page=100" \
              | jq -r '.[].name')

            for branch in $BRANCHES; do
              [[ "$branch" != feature/* ]] && continue
              echo "➡️  Feature Branch Found: $branch"

              # Check merge status safely
              COMPARE=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG_NAME/$repo/compare/$RELEASE_BRANCH...$branch" || echo "{}")

              STATUS=$(echo "$COMPARE" | jq -r '.status // "unknown"')

              if [[ "$STATUS" == "unknown" ]]; then
                echo "    ⚠️ Cannot determine merge status (branch may be deleted or repo empty)"
                continue
              fi

              if [[ "$STATUS" != "identical" ]]; then
                echo "    ❌ Not merged into $RELEASE_BRANCH (status: $STATUS)"
              else
                echo "    ✅ Already merged into $RELEASE_BRANCH"
              fi
            done
          done

          echo ""
          echo "=============================================="
          echo " Feature Branch Scan Completed"
          echo " Finished at : $(date)"
          echo "=============================================="
