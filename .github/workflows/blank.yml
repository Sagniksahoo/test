name: Feature Branch Scan (Org-wide, Any Release/*)

on:
  schedule:
    - cron: "0 3 * * 1"   # Weekly
  workflow_dispatch:

jobs:
  scan-feature-branches:
    name: Scan feature branches
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Scan feature branches in all repos
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          ORG_NAME: TechExplorers2025
        shell: bash
        run: |
          set -euo pipefail

          echo "=============================================="
          echo " GitHub Feature Branch Scan (Org-wide)"
          echo " Org : $ORG_NAME"
          echo " Started at : $(date)"
          echo "=============================================="

          echo "Fetching repositories from organization..."
          REPOS=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/orgs/$ORG_NAME/repos?per_page=100" \
            | jq -r '.[].name')

          for repo in $REPOS; do
            echo ""
            echo "================================================"
            echo " Repository: $repo"
            echo "================================================"

            BRANCHES=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$ORG_NAME/$repo/branches?per_page=100" \
              | jq -r '.[].name')

            RELEASE_BRANCHES=$(echo "$BRANCHES" | grep '^release/' || true)

            if [[ -z "$RELEASE_BRANCHES" ]]; then
              echo "   ‚ö†Ô∏è No release/* branches found in $repo ‚Äî skipping repo"
              continue
            fi

            echo "   üì¶ Release branches:"
            echo "$RELEASE_BRANCHES" | sed 's/^/      - /'

            for branch in $BRANCHES; do
              [[ "$branch" != feature/* ]] && continue

              echo ""
              echo "‚û°Ô∏è  Feature Branch Found: $branch"

              MERGED=false

              for release in $RELEASE_BRANCHES; do
                COMPARE=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
                  "https://api.github.com/repos/$ORG_NAME/$repo/compare/$release...$branch" || echo "{}")

                STATUS=$(echo "$COMPARE" | jq -r '.status // "unknown"')

                if [[ "$STATUS" == "identical" || "$STATUS" == "behind" ]]; then
                  echo "    ‚úÖ Merged into $release (status: $STATUS)"
                  MERGED=true
                  break
                else
                  echo "    ‚ùå Not merged into $release (status: $STATUS)"
                fi
              done

              if [[ "$MERGED" == false ]]; then
                echo "    üö® Feature branch is NOT merged into ANY release/* branch!"

                # ===============================
                # Last Commit Owner Information
                # ===============================

                SHA=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
                  "https://api.github.com/repos/$ORG_NAME/$repo/branches/$branch" \
                  | jq -r '.commit.sha')

                COMMIT=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
                  "https://api.github.com/repos/$ORG_NAME/$repo/commits/$SHA")

                OWNER_NAME=$(echo "$COMMIT" | jq -r '.commit.author.name // "Unknown"')
                OWNER_EMAIL=$(echo "$COMMIT" | jq -r '.commit.author.email // "Not available"')
                OWNER_LOGIN=$(echo "$COMMIT" | jq -r '.author.login // "Not linked"')
                COMMIT_DATE=$(echo "$COMMIT" | jq -r '.commit.author.date // "Unknown"')
                COMMIT_MESSAGE=$(echo "$COMMIT" | jq -r '.commit.message | split("\n")[0]')

                echo "    üîé Last Commit Details:"
                echo "       üîë Commit SHA     : $SHA"
                echo "       üóìÔ∏è  Commit Date    : $COMMIT_DATE"
                echo "       üë§ Author Name    : $OWNER_NAME"
                echo "       üìß Author Email   : $OWNER_EMAIL"
                echo "       üßë GitHub Login   : $OWNER_LOGIN"
                echo "       üìù Commit Message : $COMMIT_MESSAGE"
              fi
            done
          done

          echo ""
          echo "=============================================="
          echo " Feature Branch Scan Completed"
          echo " Finished at : $(date)"
          echo "=============================================="
