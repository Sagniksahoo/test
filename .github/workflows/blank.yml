name: Feature Branch Scan (with Owner Info)

on:
  schedule:
    - cron: "0 3 * * 1"   # Weekly
  workflow_dispatch:

jobs:
  scan-feature-branches:
    name: Scan feature branches
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Scan feature branches in all repos
        env:
          GH_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          ORG_NAME: TechExplorers2025
          RELEASE_BRANCH: release
        shell: bash
        run: |
          set -euo pipefail

          echo "=============================================="
          echo " GitHub Feature Branch Scan (With Owner Info)"
          echo " Org           : $ORG_NAME"
          echo " Release Branch: $RELEASE_BRANCH"
          echo " Started at    : $(date)"
          echo "=============================================="

          echo "Fetching repositories from organization..."
          REPOS=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/orgs/$ORG_NAME/repos?per_page=100" \
            | jq -r '.[].name')

          for repo in $REPOS; do
            echo ""
            echo "------------------------------------------------"
            echo " Repository: $repo"
            echo "------------------------------------------------"

            RELEASE_EXISTS=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$ORG_NAME/$repo/branches/$RELEASE_BRANCH")

            if echo "$RELEASE_EXISTS" | jq -e '.name' >/dev/null 2>&1; then
              echo "   ‚úÖ $RELEASE_BRANCH exists in $repo"
            else
              echo "   ‚ö†Ô∏è $RELEASE_BRANCH branch does NOT exist in $repo, skipping comparison"
              continue
            fi

            BRANCHES=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/$ORG_NAME/$repo/branches?per_page=100" \
              | jq -r '.[].name')

            for branch in $BRANCHES; do
              [[ "$branch" != feature/* ]] && continue
              echo ""
              echo "‚û°Ô∏è  Feature Branch Found: $branch"

              COMPARE=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG_NAME/$repo/compare/$RELEASE_BRANCH...$branch" || echo "{}")

              STATUS=$(echo "$COMPARE" | jq -r '.status // "unknown"')

              if [[ "$STATUS" == "unknown" ]]; then
                echo "    ‚ö†Ô∏è Cannot determine merge status"
                continue
              fi

              if [[ "$STATUS" == "identical" ]]; then
                echo "    ‚úÖ Already merged into $RELEASE_BRANCH"
                continue
              fi

              echo "    ‚ùå Not merged into $RELEASE_BRANCH (status: $STATUS)"

              # ===============================
              # Last Commit Owner Information
              # ===============================

              SHA=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG_NAME/$repo/branches/$branch" \
                | jq -r '.commit.sha')

              COMMIT=$(curl -sSL -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG_NAME/$repo/commits/$SHA")

              OWNER_NAME=$(echo "$COMMIT" | jq -r '.commit.author.name // "Unknown"')
              OWNER_EMAIL=$(echo "$COMMIT" | jq -r '.commit.author.email // "Not available"')
              OWNER_LOGIN=$(echo "$COMMIT" | jq -r '.author.login // "Not linked"')
              COMMIT_DATE=$(echo "$COMMIT" | jq -r '.commit.author.date // "Unknown"')
              COMMIT_MESSAGE=$(echo "$COMMIT" | jq -r '.commit.message | split("\n")[0]')

              echo "    üîé Last Commit Details:"
              echo "       üîë Commit SHA     : $SHA"
              echo "       üóìÔ∏è  Commit Date    : $COMMIT_DATE"
              echo "       üë§ Author Name    : $OWNER_NAME"
              echo "       üìß Author Email   : $OWNER_EMAIL"
              echo "       üßë GitHub Login   : $OWNER_LOGIN"
              echo "       üìù Commit Message : $COMMIT_MESSAGE"

            done
          done

          echo ""
          echo "=============================================="
          echo " Feature Branch Scan Completed"
          echo " Finished at : $(date)"
          echo "=============================================="
